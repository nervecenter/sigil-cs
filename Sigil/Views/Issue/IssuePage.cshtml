@using Microsoft.AspNet.Identity
@using Sigil.Models
@using Sigil.ViewModels
@model Issue_IssuePageViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    OrgViewModel thisOrg = Model.IssueVM.IssueCategoryVM.OrgVM;
    IssueViewModel thisIssue = Model.IssueVM;
    IEnumerable<CommentViewModel> issueComments = Model.IssueComments;
    IEnumerable<OfficialResponseViewModel> official = Model.OfficialResponses;
    IEnumerable<SubscriptionViewModel> userSubs = Model.UserVM.UserSubscriptions;

    UserVoteCol userVote = ViewBag.userVote;

    ViewBag.Title = "Sigil - " + thisIssue.Title;

    bool pull = false;

}

<div class="col-md-9 col-lg-9">
    @*<img class="img-rounded img-responsive org-banner-small" src="@(Sigil.Controllers.ImageController<Org>.Get_Banner(thisOrg))">*@
    <div class="btn-group btn-group-sm btn-group-justified" style="margin-bottom:20px;">
        <a class="btn btn-warning" href="/@thisOrg.OrgURL">Main feed</a>
        <a class="btn btn-info" href="/@thisOrg.OrgURL/responses">Responses</a>
        <a class="btn btn-success" href="/@thisOrg.OrgURL/@thisIssue.IssueId/data">Data</a>

        @if ( !Request.IsAuthenticated ) {
            <a class="btn btn-primary subscribe" onclick="redirectToLogin()">Subscribe to @thisOrg.OrgName</a>
        } else if ( userSubs.Any<SubscriptionViewModel>( s => s.subName == thisOrg.OrgName ) ) {
            <a class="btn btn-danger unsubscribe" onclick="unsubscribe(this, '@thisOrg.OrgURL')">Unsubscribe from @thisOrg.OrgName</a>
        } else {
            <a class="btn btn-primary subscribe" onclick="subscribe(this, '@thisOrg.OrgURL')">Subscribe to @thisOrg.OrgName</a>
        }
    </div>
    <article class="panel panel-default">
        @Html.Partial( "../Shared/_IssuePanelPartial", thisIssue )
        <div class="panel-body">@thisIssue.Text</div>
    </article>
    @if ( official.Count() > 0) {
        <div class="panel panel-primary">
            @foreach (var OfResponse in official)
            {
                <div class="panel-heading">Official Response</div>
                <div class="panel-body">
                    <div class="media">
                        <a href="#" class="pull-left">
                            <img src="@OfResponse.OfficialUserIcon" class="media-object" alt="Sample Image">
                        </a>
                        <div class="media-body">
                            <h4 class="media-heading">@OfResponse.OfficialUserDisplayName<small><i> Posted @*@Sigil.Controllers.IssueController.TimeSince(OfResponse.createTime)*@</i></small></h4>
                            <p>
                                @OfResponse.Text
                            </p>
                            <div class="btn-group glyphicon-position" data-toggle="buttons">
                                <button type="button" class="btn btn-success btn-xs"><!--<span class="glyphicon glyphicon-ok"></span>--> Helpful</button>
                                <button type="button" class="btn btn-danger btn-xs"><!--<span class="glyphicon glyphicon-remove"></span>--> Unhelpful</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    <div class="panel panel-default">
        <div class="panel-heading">Comments</div>
        <div class="panel-body">
            @if (issueComments.Count<CommentViewModel>() == 0) 
            {
                <i>No comments yet.</i>
            } 
            else 
            {
                foreach ( CommentViewModel comm in issueComments ) 
                {
                    <div class="media">
                        <a href="#" class=@((pull = !pull) ? "pull-left" : "pull-right")>
                            <img src="@comm.CommentUserIcon" class="media-object" alt="Sample Image">
                        </a>
                        <div class="media-body">
                            <h4 class="media-heading">@comm.CommentUserDisplayName<small><i>Posted @*@Sigil.Controllers.IssueController.TimeSince( @comm.postDate )<*@/i></small></h4>
                            <p>@comm.Text</p>
                        </div>
                    </div>

                }
            }
            @if ( Request.IsAuthenticated ) 
            {
                <form method="post" class="issue-add-comment">
                    <div class="form-group">
                        <label for="inputComment">Add a comment</label>
                        <textarea type="text" name="text" class="form-control" id="inputComment" placeholder="What would you like to say?"></textarea>
                        @Html.ValidationMessage( "text" )
                    </div>
                    @*@if (Sigil.Controllers.AccountController.CheckUserRole(User.Identity.GetUserId(), thisOrg.Id))
                    {
                        <input type="checkbox" name="IsOfficial" id="IsOfficial" />
                        <label for="IsOfficial">Is Official Comment</label><br />
                    }*@
                    <button type="submit" name="buttonSubmit" class="btn btn-primary">Submit</button>
                    
                </form>
            }
        </div>
    </div>
</div>
@Html.Partial( "../Shared/_SideBar", userSubs )